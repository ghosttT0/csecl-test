<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>报名管理</title>
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 24px; background: #f7f8fa; }
		h1 { margin: 0 0 16px; font-size: 20px; }
		.toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; }
		input, select { padding: 8px 10px; border: 1px solid #d6dae1; border-radius: 8px; font-size: 14px; }
		button { padding: 8px 10px; background: #1677ff; color: #fff; border: 0; border-radius: 8px; cursor: pointer; font-size: 14px; }
		button.secondary { background: #6b7280; }
		button.danger { background: #ef4444; }
		table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; }
		th, td { padding: 10px 12px; border-bottom: 1px solid #eef1f5; text-align: left; font-size: 13px; }
		th { background: #f3f4f6; color: #374151; font-weight: 600; }
		.actions { display: flex; gap: 8px; }
		.pager { margin-top: 12px; display: flex; align-items: center; gap: 8px; }
		.msg { margin: 8px 0; color: #d93025; min-height: 18px; font-size: 13px; }
		.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
		.nav a { text-decoration: none; color: #1677ff; margin-left: 12px; font-size: 13px; }
		.formgrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 10px 0; }
		.formgrid input { width: 100%; }
		.dialog { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.3); }
		.dialog .panel { width: 560px; max-width: 92vw; background: #fff; border-radius: 10px; padding: 16px; }
		.dialog.show { display: flex; }
	</style>
</head>
<body>
	<div class="header">
		<h1>报名管理</h1>
		<div class="nav">
			<a href="index.html">登录</a>
			<a href="announce.html">发布公告</a>
			<a href="#" id="logout">退出登录</a>
		</div>
	</div>

	<div class="toolbar">
		<input id="kw" placeholder="按学号搜索" />
		<input id="dir" placeholder="方向筛选" />
		<input id="grd" placeholder="年级筛选" />
		<button id="search">查询</button>
		<button id="newApp" class="secondary">新增</button>
	</div>
	<div id="msg" class="msg"></div>

	<table>
		<thead>
			<tr>
				<th>ID</th>
				<th>姓名</th>
				<th>学号</th>
				<th>年级</th>
				<th>方向</th>
				<th>分数</th>
				<th>操作</th>
			</tr>
		</thead>
		<tbody id="tbody"></tbody>
	</table>
	<div class="pager">
		<button id="prev" class="secondary">上一页</button>
		<span id="pginfo"></span>
		<button id="next" class="secondary">下一页</button>
	</div>

	<!-- 编辑弹窗 -->
	<div id="dlg" class="dialog">
		<div class="panel">
			<h3 id="dlgTitle">新增报名</h3>
			<div class="formgrid">
				<input id="f_name" placeholder="姓名" />
				<input id="f_number" placeholder="学号" />
				<input id="f_grade" placeholder="年级" />
				<input id="f_direction" placeholder="发展方向" />
				<input id="f_phone" placeholder="联系电话" />
				<input id="f_math" placeholder="高考数学" />
				<input id="f_english" placeholder="高考英语" />
				<input id="f_value" placeholder="评分(可选)" />
			</div>
			<div class="formgrid" style="grid-template-columns: 1fr;">
				<input id="f_remark" placeholder="管理员备注" />
			</div>
			<div style="display:flex; gap:8px; justify-content:flex-end; margin-top: 12px;">
				<button id="dlgCancel" class="secondary">取消</button>
				<button id="dlgOk">保存</button>
			</div>
		</div>
	</div>

	<script>
	const BASE = location.origin;
	let page = 1, pageSize = 10, totalPages = 1;
	const tbody = document.getElementById('tbody');
	const msg = document.getElementById('msg');

	function showMsg(t){ msg.textContent = t || ''; }
	function fmt(v){ return v==null? '' : v; }

	async function api(path, opts={}){
		const res = await fetch(`${BASE}${path}`, { credentials: 'include', ...opts });
		const data = await res.json().catch(()=>({}));
		if(!res.ok || data.success===false){ throw new Error(data.message || res.statusText); }
		return data;
	}

	async function load(){
		showMsg('');
		try {
			const kw = document.getElementById('kw').value.trim();
			const dir = document.getElementById('dir').value.trim();
			const grd = document.getElementById('grd').value.trim();
			const q = new URLSearchParams({ page, page_size: pageSize });
			if(kw) q.set('keyword', kw);
			if(dir) q.set('direction', dir);
			if(grd) q.set('grade', grd);
			const data = await api(`/admin/applications/?${q.toString()}`);
			renderRows(data.data);
			document.getElementById('pginfo').textContent = `第 ${data.pagination.current_page} / ${data.pagination.total_pages} 页（共 ${data.pagination.total_items} 条）`;
			totalPages = data.pagination.total_pages;
		} catch(e){ showMsg(e.message); }
	}

	function renderRows(list){
		tbody.innerHTML = list.map(x => `
			<tr>
				<td>${x.id}</td>
				<td>${fmt(x.name)}</td>
				<td>${fmt(x.number)}</td>
				<td>${fmt(x.grade)}</td>
				<td>${fmt(x.follow_direction)}</td>
				<td>${fmt(x.value)}</td>
				<td class="actions">
					<button onclick="detail(${x.id})" class="secondary">详情</button>
					<button onclick="score(${x.id})">打分</button>
					<button onclick="remark(${x.id})" class="secondary">备注</button>
					<button onclick="del(${x.id})" class="danger">删除</button>
				</td>
			</tr>
		`).join('');
	}

	window.detail = async function(id){
		try{ const data = await api(`/admin/applications/${id}/`); alert(JSON.stringify(data.data, null, 2)); }catch(e){ showMsg(e.message); }
	}
	window.score = async function(id){
		const v = prompt('请输入分数(1-100)'); if(!v) return;
		try{ await api(`/admin/applications/${id}/score/`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ score: Number(v) }) }); load(); }catch(e){ showMsg(e.message); }
	}
	window.remark = async function(id){
		const v = prompt('请输入备注'); if(v==null) return;
		try{ await api(`/admin/applications/${id}/remark/`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ remark: v }) }); load(); }catch(e){ showMsg(e.message); }
	}
	window.del = async function(id){
		if(!confirm('确认删除该记录？')) return;
		try{ await api(`/admin/applications/${id}/delete/`, { method:'POST' }); load(); }catch(e){ showMsg(e.message); }
	}

	// 新增/编辑弹窗
	const dlg = document.getElementById('dlg');
	const dlgOk = document.getElementById('dlgOk');
	document.getElementById('newApp').addEventListener('click', () => { openDlg(); });
	document.getElementById('search').addEventListener('click', () => { page=1; load(); });
	document.getElementById('prev').addEventListener('click', () => { if(page>1){ page--; load(); }});
	document.getElementById('next').addEventListener('click', () => { if(page<totalPages){ page++; load(); }});
	document.getElementById('logout').addEventListener('click', async () => { try{ await api('/admin/auth/logout/', { method:'POST' }); location.href='index.html'; }catch(e){ showMsg(e.message);} });
	document.getElementById('dlgCancel').addEventListener('click', () => { dlg.classList.remove('show'); });

	function openDlg(){
		dlg.classList.add('show');
		dlgOk.onclick = async () => {
			try {
				const payload = {
					name: document.getElementById('f_name').value.trim(),
					number: document.getElementById('f_number').value.trim(),
					grade: document.getElementById('f_grade').value.trim(),
					follow_direction: document.getElementById('f_direction').value.trim(),
					phone_number: document.getElementById('f_phone').value.trim(),
					gaokao_math: Number(document.getElementById('f_math').value || 0),
					gaokao_english: Number(document.getElementById('f_english').value || 0),
					value: document.getElementById('f_value').value.trim(),
					admin_remark: document.getElementById('f_remark').value.trim(),
				};
				await api('/admin/applications/create/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
				load(); dlg.classList.remove('show');
			}catch(e){ showMsg(e.message); }
		};
	}

	load();
	</script>
</body>
</html>